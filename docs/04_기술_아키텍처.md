# Cute Pomodoro — 기술 아키텍처

> 개발자 온보딩용 문서

---

## 1. 기술 스택

| 분류 | 기술 | 버전 | 용도 |
|------|------|------|------|
| UI 프레임워크 | React | 19.2.0 | SPA 구성 |
| 언어 | TypeScript | ~5.9.3 | 타입 안전성 |
| 빌드 도구 | Vite | 7.2.4 | 개발 서버, 번들링 |
| 상태관리 | Zustand | 5.0.11 | 전역 상태 + 로컬 영속성 |
| 애니메이션 | Framer Motion | 12.30.0 | 스프링 기반 UI 애니메이션 |
| 백엔드/DB | Supabase | 2.97.0 | Auth + Postgres DB + Realtime |
| 아이콘 | Lucide React | 0.563.0 | SVG 아이콘 |
| 날짜 처리 | date-fns | 4.1.0 | 날짜 포맷·연산 |

**TypeScript 설정** (엄격 모드):
- `noUnusedLocals`, `noUnusedParameters` 활성화
- `strict: true`

---

## 2. 디렉토리 구조

```
cute_pomodoro/
├── src/
│   ├── App.tsx                         # 앱 루트: 라우팅, 레이아웃, 게임 이벤트 처리
│   ├── main.tsx                        # React 진입점
│   ├── index.css                       # 디자인 시스템 (CSS 변수, 글로벌 스타일)
│   │
│   ├── data/
│   │   └── items.ts                    # 아이템 정의, 업적 정의, 가챠/합성 로직
│   │
│   ├── features/                       # 도메인별 상태 스토어 (Zustand)
│   │   ├── game/useGameStore.ts        # 메인 게임 상태
│   │   ├── timer/useTimerStore.ts      # 타이머 상태
│   │   ├── auth/useAuthStore.ts        # 인증 상태
│   │   └── room/useRoomStore.ts        # 친구방 실시간 상태
│   │
│   ├── components/                     # UI 컴포넌트
│   │   ├── timer/
│   │   │   ├── TimerDisplay.tsx        # 타이머 메인 UI
│   │   │   └── ItemRewardPopup.tsx     # 세션 완료 보상 팝업
│   │   ├── character/
│   │   │   ├── CharacterView.tsx       # 캐릭터 렌더링 (장착 아이템 반영)
│   │   │   └── CharacterSelect.tsx     # 온보딩 캐릭터 선택
│   │   ├── shop/
│   │   │   └── ShopView.tsx            # 상점 UI
│   │   ├── inventory/
│   │   │   ├── InventoryView.tsx       # 인벤토리 목록 UI
│   │   │   └── CraftingView.tsx        # 합성 UI
│   │   ├── room/
│   │   │   └── RoomView.tsx            # 친구방 UI
│   │   ├── calendar/
│   │   │   └── CalendarView.tsx        # 캘린더 UI
│   │   └── auth/
│   │       ├── AuthPage.tsx            # 최초 진입 인증 페이지
│   │       └── AuthModal.tsx           # 인앱 로그인 모달
│   │
│   ├── lib/
│   │   └── supabase.ts                 # Supabase 클라이언트 초기화
│   │
│   └── utils/
│       ├── audio.ts                    # 사운드 이펙트 (playClick, playNotification, playError)
│       └── sessionId.ts               # 게스트 세션 ID 생성/관리
│
├── public/
│   └── characters/
│       ├── cat.png                     # 고양이 캐릭터 이미지
│       └── fox.png                     # 여우 캐릭터 이미지
│
├── .env.local                          # Supabase 환경변수 (git 제외)
├── package.json
├── vite.config.ts
└── tsconfig.json
```

---

## 3. 상태관리 (Zustand 스토어 4개)

### 3-1. useGameStore (메인 게임 상태)

**파일**: `src/features/game/useGameStore.ts`

```typescript
interface GameState {
  // 유저 정보
  selectedCharacter: 'cat' | 'fox'
  nickname: string
  hasChosenCharacter: boolean

  // 경제
  coins: number

  // 인벤토리
  inventory: { instanceId: string; definitionId: string }[]
  equipped: {
    background: string | null  // definitionId
    accessory: string | null
    skin: string | null
  }

  // 기록
  sessionHistory: { date: string; startedAt: string; durationSeconds: number }[]
  achievements: { id: string; unlockedAt: string | null }[]

  // 보상 대기
  pendingReward: ItemDefinition | null

  // 클라우드
  userId: string | null
  isSyncing: boolean
}
```

**주요 액션**

| 액션 | 설명 |
|------|------|
| `selectCharacter(char, nick)` | 온보딩: 캐릭터·닉네임 설정 |
| `addCoins(amount)` | 코인 증감 (음수 가능) |
| `addInventoryItem(def)` | 아이템 인벤토리에 추가 |
| `equipItem(type, defId)` | 아이템 장착 (같은 타입 이전 장착 해제) |
| `addSessionRecord(record)` | 집중 세션 기록 추가 + 연속 달성 업적 체크 |
| `unlockAchievement(id)` | 업적 달성 처리 + 코인 지급 |
| `synthesizeAndConsume(instanceIds, result)` | 합성: 10개 소모 → 1개 추가 |
| `setPendingReward(item)` | 보상 대기 아이템 설정 |
| `claimReward()` | 대기 보상 수령 (인벤토리에 추가) |
| `loadFromCloud(userId)` | Supabase에서 전체 상태 로드 |
| `clearUserId()` | 로그아웃 처리 |

**로컬 영속성**
```typescript
// Zustand persist 미들웨어
persist(store, {
  name: 'cute-pomodoro-v2',
  // 제외: userId, isSyncing, pendingReward
})
```

---

### 3-2. useTimerStore (타이머 상태)

**파일**: `src/features/timer/useTimerStore.ts`

```typescript
interface TimerState {
  timeLeft: number          // 남은 시간 (초)
  mode: 'focus' | 'shortBreak' | 'longBreak'
  status: 'idle' | 'running' | 'paused' | 'completed'
  cyclesCompleted: number   // 총 집중 완료 횟수 (누적)
  cycleInSet: number        // 현재 세트 내 위치 (0~3)
  focusStartTime: Date | null

  // 설정값
  focusDuration: number     // 기본 1500 (25분)
  shortBreakDuration: number // 기본 300 (5분)
  longBreakDuration: number  // 기본 900 (15분)
  cyclesUntilLongBreak: number // 기본 4
}
```

**주요 액션**

| 액션 | 설명 |
|------|------|
| `tick()` | 1초 감소 (App.tsx의 setInterval에서 호출) |
| `setStatus(status)` | 시작/일시정지/완료 제어 |
| `advanceCycle()` | 집중 완료 후 다음 휴식으로 전환 |
| `advanceToFocus()` | 휴식 완료 후 집중으로 전환 |
| `setDurations(f, s, l)` | 타이머 시간 설정 변경 |

---

### 3-3. useAuthStore (인증 상태)

**파일**: `src/features/auth/useAuthStore.ts`

```typescript
interface AuthState {
  user: User | null         // Supabase User 객체
  status: 'loading' | 'authenticated' | 'guest'
  error: string | null      // 한국어 에러 메시지
}
```

**주요 액션**

| 액션 | 설명 |
|------|------|
| `init(callback)` | 앱 마운트 시 호출. Supabase onAuthStateChange 구독. 로그인 시 callback(userId) 실행 |
| `signIn(email, pw, cb)` | 이메일/비밀번호 로그인 |
| `signUp(email, pw, cb)` | 이메일/비밀번호 회원가입 |
| `signOut()` | 로그아웃 |
| `clearError()` | 에러 초기화 |

**에러 메시지 현지화** (한국어)
- 잘못된 자격증명 → "이메일 또는 비밀번호가 올바르지 않아요"
- 이미 가입된 이메일 → "이미 가입된 이메일이에요"
- 비밀번호 너무 짧음 → "비밀번호는 최소 6자리여야 해요"
- 요청 너무 많음 → "요청이 너무 많아요"
- 네트워크 오류 → "네트워크 오류가 발생했어요"

---

### 3-4. useRoomStore (친구방 실시간 상태)

**파일**: `src/features/room/useRoomStore.ts`

```typescript
interface RoomState {
  roomId: string | null       // "room_{CODE}" 형식
  roomCode: string | null     // 6자리 영숫자
  members: RoomMember[]
  isConnected: boolean
  error: string | null
  channel: RealtimeChannel | null  // Supabase Realtime 구독 객체
}

interface RoomMember {
  userId: string
  nickname: string
  characterId: 'cat' | 'fox'
  timerStatus: 'idle' | 'running' | 'paused' | 'completed'
  focusSecondsToday: number
}
```

**주요 액션**

| 액션 | 설명 |
|------|------|
| `createRoom(userId, nick, char, focusSec)` | 방 생성 + Supabase Realtime 구독 |
| `joinRoom(code, userId, nick, char, focusSec)` | 방 참여 |
| `leaveRoom(userId)` | 방 나가기 (DB에서 멤버 삭제) |
| `broadcastTimerStatus(userId, status)` | 타이머 상태 브로드캐스트 |
| `broadcastFocusSeconds(userId, seconds)` | 오늘 집중 시간 브로드캐스트 |

**실시간 동기화**: Supabase `postgres_changes` 이벤트 구독 (INSERT/UPDATE/DELETE on `room_members`)

---

## 4. Supabase 데이터베이스 스키마

### 4-1. user_profiles

| 컬럼 | 타입 | 설명 |
|------|------|------|
| user_id | UUID (PK) | Supabase auth.users 참조 |
| nickname | text | 닉네임 |
| selected_character | text | 'cat' \| 'fox' |
| has_chosen_character | boolean | 온보딩 완료 여부 |
| coins | integer | 보유 코인 |
| equipped_background | text \| null | 장착 배경 ID |
| equipped_accessory | text \| null | 장착 악세서리 ID |
| equipped_skin | text \| null | 장착 스킨 ID |
| updated_at | timestamp | 마지막 업데이트 |

### 4-2. user_inventory

| 컬럼 | 타입 | 설명 |
|------|------|------|
| user_id | UUID | 유저 참조 |
| instance_id | text | 아이템 인스턴스 고유 ID (중복 허용) |
| definition_id | text | items.ts의 아이템 ID |

### 4-3. user_sessions

| 컬럼 | 타입 | 설명 |
|------|------|------|
| user_id | UUID | 유저 참조 |
| session_date | date | YYYY-MM-DD |
| started_at | timestamp | 세션 시작 시각 |
| duration_seconds | integer | 집중 시간 (초) |

### 4-4. user_achievements

| 컬럼 | 타입 | 설명 |
|------|------|------|
| user_id | UUID | 유저 참조 |
| achievement_id | text | ACHIEVEMENTS 배열의 id |
| unlocked_at | timestamp \| null | 달성 시각 |

### 4-5. rooms

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | text (PK) | "room_{CODE}" 형식 |
| host_user_id | text | 방장 유저 ID |

### 4-6. room_members

| 컬럼 | 타입 | 설명 |
|------|------|------|
| room_id | text | rooms.id 참조 |
| user_id | text | 멤버 유저 ID |
| nickname | text | 닉네임 |
| character_id | text | 'cat' \| 'fox' |
| timer_status | text | 'idle' \| 'running' \| 'paused' \| 'completed' |
| focus_seconds_today | integer | 오늘 총 집중 시간 |

---

## 5. 클라우드 동기화 전략

### 5-1. 동기화 원칙

- **로컬 우선**: 모든 상태 변경은 로컬(Zustand)에 먼저 적용
- **fire-and-forget**: 로컬 업데이트 후 Supabase에 비동기 백그라운드 저장
- **오류 허용**: 클라우드 동기화 실패 시 로컬 데이터 유지 (graceful degradation)

### 5-2. 로그인 시 데이터 로드 순서

```typescript
// loadFromCloud(userId) 내부 처리
await Promise.all([
  fetchUserProfile(userId),      // 코인, 장착 아이템, 캐릭터
  fetchUserInventory(userId),    // 인벤토리 전체
  fetchUserSessions(userId),     // 세션 히스토리
  fetchUserAchievements(userId), // 업적 현황
])
```

### 5-3. 최초 로그인 처리

- 로컬에 진행 데이터가 있는 경우: 유저에게 선택지 제공
  - **현재 진행 유지**: 로컬 데이터를 클라우드에 업로드
  - **새로 시작**: `resetForNewAccount()` 호출 → 로컬 초기화

### 5-4. 로컬 영속성 키

```
localStorage key: "cute-pomodoro-v2"
```

---

## 6. 인증 플로우 다이어그램

```
앱 마운트
  → useAuthStore.init() 호출
  → Supabase onAuthStateChange 리스너 등록

Case A: 기존 세션 있음
  → status = 'authenticated'
  → loadFromCloud(user.id) 실행

Case B: 세션 없음
  → status = 'guest'
  → AuthPage 표시 (로그인 / 회원가입 / 게스트 계속)

Case C: 게스트 선택
  → status = 'guest', guestAllowed = true
  → 로컬 데이터만 사용

Case D: 로그인 성공
  → Supabase session 발급
  → onAuthStateChange 발화 → status = 'authenticated'
  → loadFromCloud() 실행
```

---

## 7. 세션 ID 관리

**파일**: `src/utils/sessionId.ts`

- 인증 없는 게스트 유저도 친구방 기능을 사용할 수 있도록 세션 기반 임시 ID 생성
- `SESSION_USER_ID` 상수로 export
- 브라우저 세션 동안 유지 (페이지 새로고침 시 재생성)

---

## 8. 환경변수

**파일**: `.env.local` (git 제외 — 팀 공유 필요)

```
VITE_SUPABASE_URL=https://[프로젝트ID].supabase.co
VITE_SUPABASE_ANON_KEY=eyJ...
```

---

## 9. 디자인 시스템 (CSS 변수)

**파일**: `src/index.css`

### 색상 토큰

| 변수 | 값 | 용도 |
|------|-----|------|
| `--cream` | #FFF8F0 | 전체 배경 |
| `--rose` | #FF6B8A | 집중 모드, 주요 액션 |
| `--lavender` | #C4A8E8 | 보조 강조 |
| `--mint` | #7EDBB7 | 짧은 휴식 모드 |
| `--sky` | #89C4F4 | 긴 휴식 모드 |
| `--gold` | #FFCC44 | 코인, 보상 |
| `--text-primary` | #3D2C2C | 기본 텍스트 |
| `--text-secondary` | #7A5C5C | 보조 텍스트 |
| `--text-muted` | #B89494 | 흐린 텍스트 |

### 레이아웃 변수

| 변수 | 값 | 용도 |
|------|-----|------|
| `--header-h` | 60px | 헤더 높이 |
| `--nav-h` | 68px | 하단 네비게이션 높이 |

### 버튼 클래스

| 클래스 | 스타일 |
|--------|--------|
| `.btn` | 기본 버튼 |
| `.btn-primary` | 로즈 그라디언트 |
| `.btn-ghost` | 투명 배경 |
| `.btn-icon` | 아이콘 전용 (정사각형) |
| `.btn-mint` | 민트 색상 |

---

## 10. 개발 시 주의사항

1. **아이템 추가 시**: `src/data/items.ts`의 `ALL_ITEMS` 배열에 추가. ID는 타입_이름 형식 (예: `bg_summer`).

2. **업적 추가 시**: `ACHIEVEMENTS` 배열에 정의 추가 후, 트리거 로직을 해당 액션 위치(App.tsx 또는 useGameStore.ts)에 연결.

3. **상점 가격/확률 변경 시**: `ShopView.tsx`의 `BOX_TIERS`(가격) + `rollByTier()`(확률) + `descKo`(설명 텍스트) 모두 일치시킬 것.

4. **친구방 최대 인원**: `useRoomStore.ts`에서 10명 제한 설정. Supabase `room_members` 테이블 INSERT 전 체크.

5. **타이머 tick**: `App.tsx`의 `setInterval(tick, 1000)`이 전역 타이머. 탭 전환 시에도 동작함.

6. **코인 동기화**: `addCoins()` 호출 시 로컬 업데이트 후 Supabase `user_profiles.coins`에 비동기 업데이트.
